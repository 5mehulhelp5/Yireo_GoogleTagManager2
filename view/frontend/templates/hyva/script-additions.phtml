<?php declare(strict_types=1);

/**
 * GoogleTagManager2 plugin for Magento
 *
 * @author      Yireo (http://www.yireo.com/)
 * @copyright   Copyright (c) 2019 Yireo (http://www.yireo.com/)
 * @license     Open Software License
 */

use Magento\Framework\View\Element\Template;
use Yireo\GoogleTagManager2\ViewModel\Commons;

/** @var Template $block */
/** @var Commons $commons */
$commons = $block->getCommonsViewModel();

// @todo: rewrite Yireo_GoogleTagManager2/js/product/clicks
// @todo: rewrite Yireo_GoogleTagManager2/js/generic
?>
<script>
    document.querySelector('.product-items a.product').addEventListener('click', function(event) {
        const debugClicks = YIREO_GOOGLETAGMANAGER2_DEBUG_CLICKS || false;
        const $parent = document.querySelector(this).parent();
        const regex = /_(\d+)$/;
        const matches = $parent.attr('id').match(regex);
        const productId = matches[1];
        const productData = window['YIREO_GOOGLETAGMANAGER2_PRODUCT_DATA_ID_' + productId] || {};
        productData.item_id = productId;

        const gtmData = {
            'event': 'select_item',
            'ecommerce': {
                'items': [productData]
            }
        }

        logger('page event "select_item" (js)', gtmData);
        dataLayer.push(gtmData);

        if (debugClicks && confirm("Press to continue with redirect") === false) {
            event.preventDefault();
        }
    });
</script>
